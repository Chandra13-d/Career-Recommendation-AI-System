{% extends "base.html" %}
{% block content %}

<style>
.header-box {
    background: linear-gradient(90deg, #4c8bf5, #00c6a7);
    color: white;
    padding: 25px;
    border-radius: 14px;
    text-align: center;
    box-shadow: 0 8px 25px rgba(0,0,0,0.15);
}

.upload-card {
    border-radius: 18px;
    padding: 30px;
    background: rgba(255,255,255,0.92);
    backdrop-filter: blur(8px);
    box-shadow: 0 6px 25px rgba(0,0,0,0.1);
}

.result-card {
    border-radius: 16px;
    padding: 22px;
    background: rgba(255,255,255,0.95);
    backdrop-filter: blur(6px);
    box-shadow: 0 6px 30px rgba(0,0,0,0.08);
}

.pred-box {
    padding: 15px;
    border-left: 5px solid #4c8bf5;
    background: #f1f6ff;
    border-radius: 12px;
    margin-bottom: 15px;
}
</style>

<!-- HEADER -->
<div class="header-box mt-3">
    <h2 class="fw-bold">Upload Your Resume</h2>
    <p class="mb-0">AI will analyze your resume & recommend the best career paths</p>
</div>

<!-- UPLOAD BOX -->
<div class="upload-card mx-auto mt-4" style="max-width:700px;">
    <form id="uploadForm">

        <div class="mb-3">
            <label class="form-label fw-bold">Resume File (PDF / DOCX / TXT)</label>
            <input type="file" id="fileInput" class="form-control" name="file" required>
        </div>

        <div class="mb-3">
            <label class="form-label fw-bold">User ID (optional if logged in)</label>
            <input type="text" id="userID" class="form-control" placeholder="Enter user ID manually (optional)">
        </div>

        <button type="button" id="uploadBtn" class="btn btn-primary w-100 py-2 fw-bold">
            ðŸš€ Upload & Predict
        </button>
    </form>
</div>

<!-- RESULTS SECTION -->
<div id="resultsSection" class="mt-4 d-none">

    <div class="result-card mx-auto" style="max-width:700px;">
        <h4 class="fw-bold">ðŸ§  Extracted Resume Details</h4>
        <div id="parsedOutput" class="mt-3"></div>
    </div>

    <div class="result-card mx-auto mt-4" style="max-width:700px;">
        <h4 class="fw-bold">ðŸŽ¯ Top Career Predictions</h4>
        <div id="predictionOutput" class="mt-3"></div>
    </div>

</div>


<!-- JS -->
<script>
document.getElementById("uploadBtn").onclick = async () => {
  const fileInput = document.getElementById("fileInput");
  if (!fileInput.files.length) { 
      alert("Please select a resume file."); 
      return; 
  }

  const userId = document.getElementById("userID").value;
  const fd = new FormData();
  fd.append("file", fileInput.files[0]);
  if (userId) fd.append("user_id", userId);

  const btn = document.getElementById("uploadBtn");
  btn.disabled = true;
  btn.innerText = "Processing...";

  try {
    const r = await fetch("/api/upload_resume", { method:"POST", body: fd });
    const raw = await r.text();
    let data;

    try { data = JSON.parse(raw); }
    catch (e) {
      alert("Unexpected server response (check console).");
      console.log("Server output:", raw);
      return;
    }

    if (!r.ok) {
      alert("Error: " + (data.error || "Upload failed"));
      return;
    }

    // Display sections
    document.getElementById("resultsSection").classList.remove("d-none");

    // Parsed Resume
    const parsed = data.parsed || {};
    document.getElementById("parsedOutput").innerHTML = `
      <p><b>Name:</b> ${parsed.name || "N/A"}</p>
      <p><b>Experience:</b> ${parsed.experience || "N/A"}</p>

      <p><b>Skills:</b></p>
      <ul>${(parsed.skills||[]).map(s=>`<li>${s}</li>`).join("")}</ul>

      <p><b>Contact:</b></p>
      <ul>
        <li>Email: ${parsed.contact?.email || "N/A"}</li>
        <li>Phone: ${parsed.contact?.phone || "N/A"}</li>
      </ul>

      <p><b>AI Summary:</b></p>
      <div style="background:#eef7ff;padding:10px;border-radius:8px">
        ${parsed.ai_summary || "N/A"}
      </div>
    `;

    // Predictions
    const predDiv = document.getElementById("predictionOutput");
    predDiv.innerHTML = "";

    (data.top3 || []).forEach((role, i) => {
      predDiv.innerHTML += `
        <div class="pred-box">
          <h5><b>${i+1}. ${role.label}</b> 
              <span class="text-muted">(${(role.score*100).toFixed(2)}%)</span>
          </h5>
          <small>Matches: ${(role.raw_roles || []).slice(0,5).join(", ")}</small>
        </div>
      `;
    });

  } catch (err) {
    alert("Upload failed: " + err.message);
  }

  btn.disabled = false;
  btn.innerText = "ðŸš€ Upload & Predict";
};
</script>

{% endblock %}
